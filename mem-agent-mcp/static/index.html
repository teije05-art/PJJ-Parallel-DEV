<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MemAgent Planning System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            gap: 20px;
            height: calc(100vh - 40px);
        }

        /* ==================== SIDEBAR ==================== */
        .sidebar {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .sidebar h2 {
            font-size: 18px;
            margin-bottom: 20px;
            color: #667eea;
        }

        .section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .section:last-child {
            border-bottom: none;
        }

        .section h3 {
            font-size: 14px;
            font-weight: 600;
            color: #666;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .entity-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 10px;
        }

        .entity-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #f5f5f5;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .entity-item:hover {
            background: #e8e8ff;
        }

        .entity-item input[type="checkbox"] {
            cursor: pointer;
        }

        .entity-counter {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
        }

        .agent-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .agent-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #f5f5f5;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
        }

        .agent-item input[type="checkbox"] {
            cursor: pointer;
        }

        /* Planning Options - FIXED IDs */
        .planning-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .option-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .option-group label {
            font-size: 13px;
            font-weight: 500;
            color: #555;
        }

        .option-group input[type="number"] {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .option-group input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* FIXED: Use unique IDs for sidebar controls */
        #sidebar-max-iterations,
        #sidebar-checkpoint-interval {
            /* These now have unique IDs */
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 6px;
            font-size: 12px;
            margin-top: 15px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4caf50;
        }

        .status-dot.disconnected {
            background: #ff6b6b;
        }

        /* ==================== MAIN CONTENT ==================== */
        .main-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .input-section {
            display: flex;
            gap: 12px;
        }

        #goalInput {
            flex: 1;
            padding: 14px 18px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.2s;
            font-family: inherit;
        }

        #goalInput:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: #fafafa;
        }

        .message {
            display: flex;
            gap: 12px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 8px;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.5;
        }

        .message.user .message-content {
            background: #667eea;
            color: white;
            border-bottom-right-radius: 2px;
        }

        .message.bot .message-content {
            background: #e8e8e8;
            color: #333;
            border-bottom-left-radius: 2px;
        }

        .chat-input-section {
            padding: 15px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
            background: white;
        }

        #chatInput {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        #chatInput:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-send {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-send:hover {
            background: #5568d3;
        }

        /* ==================== RIGHT PANEL ==================== */
        .right-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .right-panel h2 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #667eea;
        }

        .progress-item {
            padding: 12px;
            background: #f5f5f5;
            border-radius: 6px;
            margin-bottom: 12px;
            font-size: 13px;
            border-left: 3px solid #667eea;
        }

        .progress-item.complete {
            border-left-color: #4caf50;
        }

        .progress-item.error {
            border-left-color: #ff6b6b;
        }

        .progress-label {
            font-weight: 600;
            margin-bottom: 4px;
            color: #333;
        }

        .progress-value {
            color: #666;
            font-size: 12px;
        }

        /* ==================== ITERATION PROGRESS BAR ==================== */
        .iteration-tracker {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .iteration-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .iteration-title {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .iteration-counter {
            font-size: 12px;
            color: #667eea;
            font-weight: bold;
            background: #e3f2fd;
            padding: 3px 10px;
            border-radius: 12px;
        }

        .progress-bar-container {
            width: 100%;
            height: 24px;
            background: #f0f0f0;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            color: white;
        }

        .iteration-dots {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .iteration-dot {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #f0f0f0;
            border: 2px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            color: #666;
            transition: all 0.2s;
            cursor: default;
        }

        .iteration-dot.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
            box-shadow: 0 0 0 2px #e3f2fd;
        }

        .iteration-dot.complete {
            background: #4caf50;
            color: white;
            border-color: #4caf50;
        }

        .iteration-dot.checkpoint {
            border-color: #ff9800;
            border-width: 3px;
        }

        /* ==================== MODAL ==================== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 40px;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #333;
        }

        .modal-section {
            margin-bottom: 25px;
        }

        .modal-section h3 {
            font-size: 14px;
            font-weight: 600;
            color: #666;
            margin-bottom: 12px;
            text-transform: uppercase;
        }

        /* FIXED: Use unique IDs for modal controls */
        #modal-max-iterations,
        #modal-checkpoint-interval {
            /* These now have unique IDs to avoid collision with sidebar */
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 30px;
            justify-content: flex-end;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .proposal-text {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #667eea;
            font-size: 13px;
            line-height: 1.6;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
        }

        /* ==================== CHECKPOINT MODAL ==================== */
        .checkpoint-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1001;
            align-items: center;
            justify-content: center;
        }

        .checkpoint-modal.active {
            display: flex;
        }

        .checkpoint-content {
            background: white;
            border-radius: 12px;
            padding: 40px;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
        }

        .checkpoint-summary {
            background: #f0f7ff;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            margin: 20px 0;
            font-size: 14px;
            line-height: 1.6;
        }

        .checkpoint-buttons {
            display: flex;
            gap: 12px;
            margin-top: 30px;
            justify-content: space-between;
        }

        .btn-approve {
            background: #4caf50;
            color: white;
            flex: 1;
        }

        .btn-approve:hover {
            background: #45a049;
        }

        .btn-reject {
            background: #ff6b6b;
            color: white;
            flex: 1;
        }

        .btn-reject:hover {
            background: #ff5252;
        }

        /* ==================== CHECKPOINT MODAL ENHANCEMENTS ==================== */
        .phase-tab {
            position: relative;
            font-size: 13px;
            padding: 12px 16px !important;
            transition: all 0.2s !important;
        }

        .phase-tab:hover {
            background: rgba(102, 126, 234, 0.05) !important;
        }

        .phase-tab.active {
            color: #667eea !important;
            border-bottom-color: #667eea !important;
        }

        .phase-panel {
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .modal-header {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 2px solid #eee;
        }

        .phase-content {
            border-radius: 8px;
        }

        /* Metric Cards */
        .metric-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .metric-label {
            font-weight: 500;
            color: #555;
            font-size: 13px;
        }

        .metric-value {
            font-size: 14px;
            font-weight: bold;
            padding: 4px 12px;
            border-radius: 6px;
            background: #f0f0f0;
        }

        .metric-value.high {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .metric-value.medium {
            background: #ffe0b2;
            color: #e65100;
        }

        .metric-value.low {
            background: #ffcdd2;
            color: #c62828;
        }

        /* Framework Tags */
        .framework-tag {
            display: inline-block;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            margin: 4px 4px 4px 0;
            font-weight: 500;
        }

        /* Memory Segment Card */
        .memory-segment {
            background: white;
            border-left: 4px solid #667eea;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .memory-segment-title {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .memory-segment-content {
            font-size: 12px;
            color: #555;
            line-height: 1.5;
        }

        /* Checkpoint Summary Box */
        .checkpoint-summary {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-left: 4px solid #667eea;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 13px;
            line-height: 1.6;
        }

        /* ==================== METRIC PROGRESS BARS ==================== */
        .metric-with-bar {
            margin-bottom: 12px;
        }

        .metric-bar-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .metric-bar-name {
            font-weight: 500;
            color: #555;
        }

        .metric-bar-percentage {
            font-weight: bold;
            color: #667eea;
            font-size: 13px;
        }

        .metric-progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }

        .metric-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 6px;
            min-width: 20px;
        }

        .metric-progress-fill.high {
            background: linear-gradient(90deg, #4caf50, #45a049);
        }

        .metric-progress-fill.medium {
            background: linear-gradient(90deg, #ff9800, #e68900);
        }

        .metric-progress-fill.low {
            background: linear-gradient(90deg, #ff6b6b, #ff5252);
        }

        /* ==================== CHECKPOINT HEADER METADATA ==================== */
        .checkpoint-header-info {
            display: flex;
            gap: 12px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .checkpoint-meta-badge {
            font-size: 11px;
            background: #f0f0f0;
            padding: 4px 10px;
            border-radius: 6px;
            color: #666;
            font-weight: 500;
            border-left: 3px solid #667eea;
        }

        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
                height: auto;
            }

            .sidebar,
            .right-panel {
                max-height: 300px;
            }
        }

        .loading {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ==================== SIDEBAR ==================== -->
        <div class="sidebar">
            <h2>Planning Setup</h2>

            <!-- Entity Selection -->
            <div class="section">
                <h3>Memory Entities</h3>
                <p style="font-size: 0.85em; color: #999; margin-bottom: 10px;">Select entities to use for memory retrieval during planning</p>
                <div class="entity-list" id="entityList">
                    <!-- Populated dynamically from /api/entities -->
                </div>
                <div class="entity-counter">Selected: <span id="entityCount">0</span></div>
            </div>

            <!-- Status -->
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Connecting...</span>
            </div>
        </div>

        <!-- ==================== MAIN CONTENT ==================== -->
        <div class="main-content">
            <!-- Input Section -->
            <div class="input-section">
                <input type="text" id="goalInput" placeholder="Describe your planning goal..." autofocus>
                <button class="btn btn-primary" id="planBtn">Plan</button>
            </div>

            <!-- Chat Container -->
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="message bot">
                        <div class="message-content">
                            Welcome to MemAgent! Describe what you'd like to plan, and I'll create a comprehensive strategy using memory and web research.
                        </div>
                    </div>
                </div>
                <div class="chat-input-section">
                    <input type="text" id="chatInput" placeholder="Type your message...">
                    <button class="btn btn-send" id="sendBtn">Send</button>
                </div>
            </div>
        </div>

        <!-- ==================== RIGHT PANEL ==================== -->
        <div class="right-panel">
            <h2>Progress</h2>

            <!-- Iteration Tracker -->
            <div class="iteration-tracker" id="iterationTracker" style="display: none;">
                <div class="iteration-header">
                    <div class="iteration-title">üìä Planning Progress</div>
                    <div class="iteration-counter" id="iterationCounter">0/0</div>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="progressBarFill" style="width: 0%;">0%</div>
                </div>
                <div class="iteration-dots" id="iterationDots"></div>
            </div>

            <!-- Status Items -->
            <div id="progressItems">
                <div class="progress-item">
                    <div class="progress-label">System Status</div>
                    <div class="progress-value">Ready</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== PROPOSAL MODAL ==================== -->
    <div class="modal" id="proposalModal">
        <div class="modal-content">
            <div class="modal-header">Planning Proposal</div>

            <div class="proposal-text" id="proposalText">
                <!-- Populated dynamically -->
            </div>

            <div class="modal-section">
                <h3>Configuration</h3>
                <!-- FIXED: Using unique IDs for modal controls -->
                <div class="option-group">
                    <label for="modal-max-iterations">Max Iterations:</label>
                    <input type="number" id="modal-max-iterations" min="1" max="20" value="3">
                </div>
                <div class="option-group">
                    <label for="modal-checkpoint-interval">Checkpoint Interval:</label>
                    <input type="number" id="modal-checkpoint-interval" min="1" max="10" value="2">
                </div>
            </div>

            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeProposalModal()">Cancel</button>
                <button class="btn btn-primary" onclick="approveProposal()">Approve & Execute</button>
            </div>
        </div>
    </div>

    <!-- ==================== CHECKPOINT MODAL ==================== -->
    <div class="checkpoint-modal" id="checkpointModal">
        <div class="checkpoint-content">
            <div class="modal-header">üéØ Checkpoint Review - Iteration <span id="checkpointNumber">1</span></div>

            <!-- Checkpoint Metadata -->
            <div class="checkpoint-header-info">
                <div class="checkpoint-meta-badge">
                    üìã Checkpoint: <span id="checkpointNumberMeta">1</span>
                </div>
                <div class="checkpoint-meta-badge">
                    üîÑ Iteration: <span id="checkpointIterationMeta">1</span>
                </div>
                <div class="checkpoint-meta-badge">
                    ü§ñ Agent: <span id="checkpointAgentMeta">Planning</span>
                </div>
            </div>

            <p style="color: #666; margin-bottom: 15px; margin-top: 15px;">Planning iteration <span id="checkpointIteration">1</span> completed. Review all 4 phases and approve to continue.</p>

            <!-- Phase Tabs Navigation -->
            <div style="display: flex; gap: 10px; border-bottom: 2px solid #eee; margin-bottom: 20px; overflow-x: auto;">
                <button class="phase-tab active" onclick="switchPhaseTab(event, 'memory')" style="padding: 12px 16px; border: none; background: none; cursor: pointer; font-weight: 500; border-bottom: 3px solid transparent; color: #666; transition: all 0.2s;">üìö Memory</button>
                <button class="phase-tab" onclick="switchPhaseTab(event, 'reasoning')" style="padding: 12px 16px; border: none; background: none; cursor: pointer; font-weight: 500; border-bottom: 3px solid transparent; color: #666; transition: all 0.2s;">üß† Reasoning</button>
                <button class="phase-tab" onclick="switchPhaseTab(event, 'verification')" style="padding: 12px 16px; border: none; background: none; cursor: pointer; font-weight: 500; border-bottom: 3px solid transparent; color: #666; transition: all 0.2s;">‚úÖ Verification</button>
                <button class="phase-tab" onclick="switchPhaseTab(event, 'learning')" style="padding: 12px 16px; border: none; background: none; cursor: pointer; font-weight: 500; border-bottom: 3px solid transparent; color: #666; transition: all 0.2s;">üìä Learning</button>
            </div>

            <!-- Phase Content Areas -->
            <div class="phase-content" style="max-height: 400px; overflow-y: auto;">
                <!-- Memory Phase -->
                <div id="phase-memory" class="phase-panel" style="display: block;">
                    <h3 style="color: #667eea; margin-bottom: 12px;">üìö Memory Segments</h3>
                    <div id="memoryContent" style="background: #f9f9f9; padding: 12px; border-radius: 6px; font-size: 14px; line-height: 1.6;">
                        <p style="color: #999;">Loading memory segments...</p>
                    </div>
                </div>

                <!-- Reasoning Phase -->
                <div id="phase-reasoning" class="phase-panel" style="display: none;">
                    <h3 style="color: #667eea; margin-bottom: 12px;">üß† Reasoning Chain</h3>
                    <div id="reasoningContent" style="background: #f9f9f9; padding: 12px; border-radius: 6px; font-size: 14px;">
                        <p style="color: #999;">Loading reasoning chain...</p>
                    </div>
                </div>

                <!-- Verification Phase -->
                <div id="phase-verification" class="phase-panel" style="display: none;">
                    <h3 style="color: #667eea; margin-bottom: 12px;">‚úÖ Verification Results</h3>
                    <div id="verificationContent" style="background: #f9f9f9; padding: 12px; border-radius: 6px; font-size: 14px;">
                        <p style="color: #999;">Loading verification results...</p>
                    </div>
                </div>

                <!-- Learning Phase -->
                <div id="phase-learning" class="phase-panel" style="display: none;">
                    <h3 style="color: #667eea; margin-bottom: 12px;">üìä Learning Metrics</h3>
                    <div id="learningContent" style="background: #f9f9f9; padding: 12px; border-radius: 6px; font-size: 14px;">
                        <p style="color: #999;">Loading learning metrics...</p>
                    </div>
                </div>
            </div>

            <!-- Checkpoint Summary (Original) -->
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
                <h3 style="color: #667eea; margin-bottom: 10px;">üìù Plan Summary</h3>
                <div class="checkpoint-summary" id="checkpointSummary" style="background: #f9f9f9; padding: 12px; border-radius: 6px; font-size: 14px; line-height: 1.6;">
                    <!-- Populated with detailed analysis -->
                </div>
            </div>

            <div class="checkpoint-buttons" style="margin-top: 20px;">
                <button class="btn btn-reject" onclick="rejectCheckpoint()">‚ùå Reject</button>
                <button class="btn btn-approve" onclick="approveCheckpoint()">‚úì Approve</button>
            </div>
        </div>
    </div>

    <!-- ==================== PLAN SELECTION MODAL ==================== -->
    <div class="modal" id="planSelectionModal">
        <div class="modal-content">
            <div class="modal-header">üìö Select Plans for Learning</div>

            <p style="color: #666; margin-bottom: 20px;">
                Which past plans should the system learn from?<br>
                <small>(Select plans similar to your current goal to improve quality)</small>
            </p>

            <div id="planList" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; margin-bottom: 15px;">
                <!-- Populated dynamically -->
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                <button class="btn btn-secondary" onclick="selectRecentPlans(3)" style="flex: 1; min-width: 120px;">Recent 3</button>
                <button class="btn btn-secondary" onclick="selectRecentPlans(5)" style="flex: 1; min-width: 120px;">Recent 5</button>
                <button class="btn btn-secondary" onclick="selectAllPlans()" style="flex: 1; min-width: 120px;">All Plans</button>
                <button class="btn btn-secondary" onclick="clearAllPlans()" style="flex: 1; min-width: 120px;">Clear All</button>
            </div>

            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="skipPlanSelection()">Skip Learning</button>
                <button class="btn btn-primary" onclick="confirmPlanSelection()">Continue to Planning</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== STATE ====================
        let sessionId = localStorage.getItem('sessionId') || Date.now().toString();
        localStorage.setItem('sessionId', sessionId);

        let selectedEntities = [];
        let selectedAgents = [];
        let currentEventSource = null;
        let currentCheckpointNumber = 0;

        // ==================== INITIALIZATION ====================
        async function initialize() {
            // Check system status
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                updateStatus('Connected', true);
            } catch (e) {
                updateStatus('Disconnected', false);
            }

            // Load entities
            await loadEntities();
            setupEventListeners();
        }

        async function loadEntities() {
            try {
                const response = await fetch('/api/entities');
                const data = await response.json();
                const entities = data.entities || [];

                const entityList = document.getElementById('entityList');
                entityList.innerHTML = '';

                if (entities.length === 0) {
                    entityList.innerHTML = '<p style="color: #999; font-size: 0.9em;">No entities found in memory system</p>';
                    return;
                }

                entities.forEach(entity => {
                    const label = document.createElement('label');
                    label.className = 'entity-item';
                    label.title = entity.description || '';
                    label.innerHTML = `
                        <input type="checkbox" value="${entity.name}" checked>
                        <span>${entity.display_name || entity.name}</span>
                        <span style="font-size: 0.8em; color: #999; margin-left: 5px;">${entity.references} ref</span>
                    `;
                    label.querySelector('input').addEventListener('change', updateEntitySelection);
                    entityList.appendChild(label);
                });

                updateEntitySelection();
            } catch (e) {
                console.error('Error loading entities:', e);
                document.getElementById('entityList').innerHTML = '<p style="color: red;">Error loading entities</p>';
            }
        }

        function updateEntitySelection() {
            const checkboxes = document.querySelectorAll('#entityList input[type="checkbox"]:checked');
            selectedEntities = Array.from(checkboxes).map(cb => cb.value);
            document.getElementById('entityCount').textContent = selectedEntities.length;
        }

        function setupEventListeners() {
            document.getElementById('planBtn').addEventListener('click', planGoal);
            document.getElementById('sendBtn').addEventListener('click', sendChat);
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendChat();
            });
            document.getElementById('goalInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') planGoal();
            });

            // Agent selection
            document.querySelectorAll('#agentList input[type="checkbox"]').forEach(cb => {
                cb.addEventListener('change', () => {
                    selectedAgents = Array.from(
                        document.querySelectorAll('#agentList input[type="checkbox"]:checked')
                    ).map(cb => cb.value);
                });
            });

            selectedAgents = Array.from(
                document.querySelectorAll('#agentList input[type="checkbox"]:checked')
            ).map(cb => cb.value);
        }

        function updateStatus(text, connected) {
            document.getElementById('statusDot').className = connected ? 'status-dot' : 'status-dot disconnected';
            document.getElementById('statusText').textContent = text;
        }

        // ==================== PLANNING ====================
        async function planGoal() {
            const goal = document.getElementById('goalInput').value;
            if (!goal.trim()) return;

            // Show loading state
            document.getElementById('planBtn').disabled = true;

            try {
                // Default values - user can adjust in proposal modal later
                const maxIterations = 3;
                const checkpointInterval = 2;

                // Generate proposal
                const proposalResponse = await fetch('/api/generate-proposal', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        goal: goal,
                        selected_entities: selectedEntities,
                        selected_agents: selectedAgents,
                        max_iterations: maxIterations,
                        checkpoint_interval: checkpointInterval,
                        session_id: sessionId
                    })
                });

                if (!proposalResponse.ok) {
                    throw new Error('Failed to generate proposal');
                }

                const proposal = await proposalResponse.json();

                // Show proposal modal
                showProposalModal(proposal, maxIterations, checkpointInterval);

            } catch (e) {
                addMessage('bot', `‚ùå Error: ${e.message}`);
            } finally {
                document.getElementById('planBtn').disabled = false;
            }
        }

        function showProposalModal(proposal, maxIterations, checkpointInterval) {
            const proposalText = document.getElementById('proposalText');

            // Format proposal - display actual proposal content
            let html = '';

            // Display the full proposal text (if it exists)
            if (proposal.proposal) {
                // Convert markdown-style headings to HTML
                let proposalContent = proposal.proposal
                    .replace(/^# /gm, '<h3 style="color: #333; margin-top: 15px; margin-bottom: 10px;">')
                    .replace(/\n(?=# )/gm, '</h3>\n')
                    .replace(/\n(?=[^#])/gm, '<br>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>');
                html += `<div style="max-height: 400px; overflow-y: auto; padding: 10px; background: #f9f9f9; border-radius: 5px;">${proposalContent}</div>`;
            } else if (proposal.goal) {
                // Fallback if proposal.proposal is not available
                html = `<h4 style="color: #333; margin-bottom: 10px;">${proposal.goal}</h4>`;
            }

            // Add coverage metrics
            html += `<div style="margin-top: 15px; padding: 10px; background: #f0f8ff; border-radius: 5px;">`;
            html += `<p><strong>Memory Coverage:</strong> ${(proposal.memory_percentage * 100).toFixed(0)}%</p>`;
            html += `<p><strong>Research Coverage:</strong> ${(proposal.research_percentage * 100).toFixed(0)}%</p>`;
            html += `</div>`;

            if (proposal.entity_analysis) {
                html += `<hr style="margin: 10px 0; border: none; border-top: 1px solid #ddd;">`;
                html += `<p>${proposal.entity_analysis}</p>`;
            }

            proposalText.innerHTML = html;

            // Set modal values from sidebar
            document.getElementById('modal-max-iterations').value = maxIterations;
            document.getElementById('modal-checkpoint-interval').value = checkpointInterval;

            document.getElementById('proposalModal').classList.add('active');
        }

        function closeProposalModal() {
            document.getElementById('proposalModal').classList.remove('active');
        }

        async function approveProposal() {
            // Get values from MODAL (not sidebar)
            const maxIterations = parseInt(document.getElementById('modal-max-iterations').value) || 3;
            const checkpointInterval = parseInt(document.getElementById('modal-checkpoint-interval').value) || 2;
            const goal = document.getElementById('goalInput').value;

            // Store planning config for later use
            window.planningConfig = { goal, maxIterations, checkpointInterval };

            closeProposalModal();
            addMessage('bot', 'Preparing planning with learning...');

            // Show plan selection modal
            showPlanSelectionModal();
        }

        // ==================== PLAN SELECTION GATE ====================

        async function showPlanSelectionModal() {
            try {
                // Fetch available plans from backend
                const response = await fetch('/api/get-available-plans');
                const data = await response.json();

                if (data.status === 'no_plans' || data.plans.length === 0) {
                    // No plans available, skip selection and go directly to planning
                    addMessage('bot', 'No completed plans available for learning. Starting fresh planning...');
                    window.selectedPlans = [];
                    setTimeout(() => confirmPlanSelection(), 500);
                    return;
                }

                // Populate plan list
                const planListDiv = document.getElementById('planList');
                planListDiv.innerHTML = '';

                data.plans.forEach((plan, index) => {
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `plan-${index}`;
                    checkbox.value = plan.file;
                    checkbox.class = 'plan-checkbox';

                    const label = document.createElement('label');
                    label.htmlFor = `plan-${index}`;
                    label.style.display = 'block';
                    label.style.padding = '8px';
                    label.style.marginBottom = '5px';
                    label.style.cursor = 'pointer';
                    label.style.backgroundColor = '#f5f5f5';
                    label.style.borderRadius = '4px';
                    label.innerHTML = `
                        <input type="checkbox" id="plan-${index}" value="${plan.file}"
                               style="margin-right: 10px; cursor: pointer;" class="plan-checkbox">
                        <strong>${plan.goal.substring(0, 60)}...</strong><br>
                        <small style="color: #999;">
                            Quality: ${plan.quality.toFixed(1)}/10 |
                            Created: ${plan.created} |
                            Size: ${plan.size_kb.toFixed(1)}KB
                        </small>
                    `;

                    planListDiv.appendChild(label);
                });

                // Show modal
                document.getElementById('planSelectionModal').classList.add('active');
                addMessage('bot', `Found ${data.plans.length} completed plans. Select which to learn from.`);

            } catch (error) {
                console.error('Error fetching available plans:', error);
                addMessage('bot', 'Could not fetch available plans. Proceeding without learning.');
                window.selectedPlans = [];
                setTimeout(() => confirmPlanSelection(), 500);
            }
        }

        function selectRecentPlans(count) {
            const checkboxes = document.querySelectorAll('.plan-checkbox');
            clearAllPlans();
            // Select the first `count` plans (they're sorted by recent first)
            for (let i = 0; i < Math.min(count, checkboxes.length); i++) {
                checkboxes[i].checked = true;
            }
        }

        function selectAllPlans() {
            document.querySelectorAll('.plan-checkbox').forEach(cb => cb.checked = true);
        }

        function clearAllPlans() {
            document.querySelectorAll('.plan-checkbox').forEach(cb => cb.checked = false);
        }

        function skipPlanSelection() {
            window.selectedPlans = [];
            closePlanSelectionModal();
            confirmPlanSelection();
        }

        function closePlanSelectionModal() {
            document.getElementById('planSelectionModal').classList.remove('active');
        }

        function confirmPlanSelection() {
            // Get selected plan files
            const selectedCheckboxes = document.querySelectorAll('.plan-checkbox:checked');
            window.selectedPlans = Array.from(selectedCheckboxes).map(cb => cb.value);

            if (window.selectedPlans.length > 0) {
                addMessage('bot', `‚úì Selected ${window.selectedPlans.length} plans for learning`);
            } else {
                addMessage('bot', 'No plans selected. Starting planning without learning from past iterations.');
            }

            closePlanSelectionModal();

            // Execute plan with selected plans
            const config = window.planningConfig;
            executePlan(config.goal, config.maxIterations, config.checkpointInterval, window.selectedPlans);
        }

        // ==================== SSE EXECUTION ====================
        function executePlan(goal, maxIterations, checkpointInterval, selectedPlans = []) {
            // Stop previous event source if any
            if (currentEventSource) {
                currentEventSource.close();
            }

            // Initialize iteration tracker
            initializeIterationTracker(maxIterations);

            const params = new URLSearchParams({
                goal: goal,
                max_iterations: maxIterations,
                checkpoint_interval: checkpointInterval,
                session_id: sessionId,
                selected_plans: selectedPlans.join(',')  // LEARNING LOOP: Pass selected plans
            });

            currentEventSource = new EventSource(`/api/execute-plan?${params}`);

            currentEventSource.addEventListener('message', (event) => {
                try {
                    const data = JSON.parse(event.data);

                    switch (data.type) {
                        case 'planning_started':
                            addMessage('bot', `Starting planning for: "${goal}"`);
                            updateProgress('Status', 'Planning...');
                            break;

                        case 'iteration_started':
                            addMessage('bot', `Starting iteration ${data.iteration}/${data.max_iterations}...`);
                            updateProgress(`Iteration ${data.iteration}`, 'Running');
                            updateIterationProgress(data.iteration);
                            break;

                        case 'agent_progress':
                            updateProgress(`Agent: ${data.agent}`, 'Running');
                            break;

                        case 'checkpoint_reached':
                            currentCheckpointNumber = data.checkpoint_number;
                            markCheckpointReached(data.checkpoint_number, data.iteration || 1);
                            showCheckpointModal(data, data.checkpoint_number);
                            break;

                        case 'checkpoint_approved':
                            addMessage('bot', 'Checkpoint approved. Continuing planning...');
                            break;

                        case 'final_plan':
                            addMessage('bot', `‚úì Planning complete!\n\n${data.plan}`);
                            updateProgress('Completed', 'Done');
                            if (currentEventSource) {
                                currentEventSource.close();
                            }
                            break;

                        case 'error':
                            addMessage('bot', `‚ùå Error: ${data.error}`);
                            updateProgress('Error', data.error);
                            if (currentEventSource) {
                                currentEventSource.close();
                            }
                            break;
                    }
                } catch (e) {
                    console.error('Error parsing SSE data:', e);
                }
            });

            currentEventSource.addEventListener('error', () => {
                addMessage('bot', 'Connection lost');
                updateProgress('Disconnected', 'Connection error');
            });
        }

        // ==================== PHASE TAB SWITCHING ====================
        function switchPhaseTab(event, phaseName) {
            // Hide all phase panels
            document.querySelectorAll('.phase-panel').forEach(panel => {
                panel.style.display = 'none';
            });

            // Show selected phase panel
            const selectedPanel = document.getElementById(`phase-${phaseName}`);
            if (selectedPanel) {
                selectedPanel.style.display = 'block';
            }

            // Update tab styling
            document.querySelectorAll('.phase-tab').forEach(tab => {
                tab.style.color = '#666';
                tab.style.borderBottomColor = 'transparent';
            });

            // Highlight active tab
            event.target.style.color = '#667eea';
            event.target.style.borderBottomColor = '#667eea';
        }

        // ==================== POPULATE PHASE DATA ====================
        function populatePhaseData(checkpointData) {
            // 1. MEMORY PHASE
            if (checkpointData.memory_segments && Array.isArray(checkpointData.memory_segments)) {
                let memoryHTML = '<div>';
                checkpointData.memory_segments.forEach((segment, idx) => {
                    memoryHTML += `
                        <div class="memory-segment">
                            <div class="memory-segment-title">üìå Segment ${idx + 1}</div>
                            <div class="memory-segment-content">${escapeHtml(segment)}</div>
                        </div>
                    `;
                });
                memoryHTML += '</div>';
                document.getElementById('memoryContent').innerHTML = memoryHTML;
            } else {
                document.getElementById('memoryContent').innerHTML = '<p style="color: #999;">No memory segments available</p>';
            }

            // 2. REASONING PHASE
            if (checkpointData.reasoning_chain && Array.isArray(checkpointData.reasoning_chain)) {
                let reasoningHTML = '<div style="padding: 8px 0;">';
                checkpointData.reasoning_chain.forEach((step, idx) => {
                    reasoningHTML += `
                        <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                            <div style="flex-shrink: 0; width: 28px; height: 28px; background: #667eea; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">${idx + 1}</div>
                            <div style="flex: 1; padding-top: 4px; font-size: 13px; color: #555; line-height: 1.5;">${escapeHtml(step)}</div>
                        </div>
                    `;
                });
                reasoningHTML += '</div>';
                document.getElementById('reasoningContent').innerHTML = reasoningHTML;
            } else if (checkpointData.improvements) {
                document.getElementById('reasoningContent').innerHTML = `<p style="font-size: 13px; color: #555; line-height: 1.6;">${escapeHtml(checkpointData.improvements)}</p>`;
            } else {
                document.getElementById('reasoningContent').innerHTML = '<p style="color: #999;">No reasoning chain available</p>';
            }

            // 3. VERIFICATION PHASE
            let verificationHTML = '<div>';
            const flowMetrics = checkpointData.flow_score_metrics || {};

            if (flowMetrics.verification_quality !== undefined) {
                const verifyScore = (flowMetrics.verification_quality * 100).toFixed(1);
                const verifyLevel = flowMetrics.verification_quality > 0.7 ? 'high' : flowMetrics.verification_quality > 0.5 ? 'medium' : 'low';
                verificationHTML += `
                    <div class="metric-with-bar">
                        <div class="metric-bar-label">
                            <span class="metric-bar-name">‚úÖ Verification Quality</span>
                            <span class="metric-bar-percentage">${verifyScore}%</span>
                        </div>
                        <div class="metric-progress-bar">
                            <div class="metric-progress-fill ${verifyLevel}" style="width: ${verifyScore}%;"></div>
                        </div>
                    </div>
                `;
            }

            if (flowMetrics.reasoning_quality !== undefined) {
                const reasonScore = (flowMetrics.reasoning_quality * 100).toFixed(1);
                const reasonLevel = flowMetrics.reasoning_quality > 0.7 ? 'high' : flowMetrics.reasoning_quality > 0.5 ? 'medium' : 'low';
                verificationHTML += `
                    <div class="metric-with-bar">
                        <div class="metric-bar-label">
                            <span class="metric-bar-name">üß† Reasoning Quality</span>
                            <span class="metric-bar-percentage">${reasonScore}%</span>
                        </div>
                        <div class="metric-progress-bar">
                            <div class="metric-progress-fill ${reasonLevel}" style="width: ${reasonScore}%;"></div>
                        </div>
                    </div>
                `;
            }

            if (checkpointData.frameworks_so_far && Array.isArray(checkpointData.frameworks_so_far)) {
                verificationHTML += `
                    <div style="padding: 12px 0; border-top: 1px solid #eee; margin-top: 12px;">
                        <strong style="display: block; margin-bottom: 10px; color: #333;">üéØ Frameworks Applied:</strong>
                        <div>
                            ${checkpointData.frameworks_so_far.map(f => `<span class="framework-tag">${escapeHtml(f)}</span>`).join('')}
                        </div>
                    </div>
                `;
            }

            verificationHTML += '</div>';
            document.getElementById('verificationContent').innerHTML = verificationHTML || '<p style="color: #999;">No verification results available</p>';

            // 4. LEARNING PHASE
            let learningHTML = '<div>';

            if (flowMetrics.flow_score !== undefined) {
                const flowScore = (flowMetrics.flow_score * 100).toFixed(1);
                const flowLevel = flowMetrics.flow_score > 0.75 ? 'high' : flowMetrics.flow_score > 0.5 ? 'medium' : 'low';
                const flowColor = flowMetrics.flow_score > 0.75 ? '#4caf50' : flowMetrics.flow_score > 0.5 ? '#ff9800' : '#f44336';

                // Flow Score with progress bar
                learningHTML += `
                    <div class="metric-with-bar" style="margin-bottom: 20px;">
                        <div class="metric-bar-label">
                            <span class="metric-bar-name">üìä Overall Flow Score</span>
                            <span class="metric-bar-percentage">${flowScore}%</span>
                        </div>
                        <div class="metric-progress-bar">
                            <div class="metric-progress-fill ${flowLevel}" style="width: ${flowScore}%;"></div>
                        </div>
                        <div style="font-size: 11px; color: #999; margin-top: 6px;">Combined metric: Verification √ó Approval √ó Reasoning</div>
                    </div>
                `;

                // Sub-metrics breakdown
                learningHTML += `
                    <div style="background: #f9f9f9; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                        <div style="font-size: 11px; font-weight: 600; color: #666; margin-bottom: 8px;">Score Breakdown:</div>
                `;

                if (flowMetrics.verification_quality !== undefined) {
                    const verifyBreakdown = (flowMetrics.verification_quality * 0.4 * 100).toFixed(1);
                    learningHTML += `
                        <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px; color: #666;">
                            <span>Verification (40%)</span>
                            <span style="font-weight: 600; color: #667eea;">${verifyBreakdown}%</span>
                        </div>
                    `;
                }

                if (flowMetrics.reasoning_quality !== undefined) {
                    const reasonBreakdown = (flowMetrics.reasoning_quality * 0.2 * 100).toFixed(1);
                    learningHTML += `
                        <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px; color: #666;">
                            <span>Reasoning (20%)</span>
                            <span style="font-weight: 600; color: #667eea;">${reasonBreakdown}%</span>
                        </div>
                    `;
                }

                learningHTML += `
                        <div style="display: flex; justify-content: space-between; font-size: 11px; color: #666;">
                            <span>User Approval (40%)</span>
                            <span style="font-weight: 600; color: #667eea;">Pending</span>
                        </div>
                    </div>
                `;
            }

            if (checkpointData.data_points_so_far !== undefined) {
                learningHTML += `
                    <div class="metric-with-bar">
                        <div class="metric-bar-label">
                            <span class="metric-bar-name">üìà Data Points Collected</span>
                            <span class="metric-bar-percentage">${checkpointData.data_points_so_far}</span>
                        </div>
                    </div>
                `;
            }

            learningHTML += '</div>';
            document.getElementById('learningContent').innerHTML = learningHTML || '<p style="color: #999;">No learning metrics available</p>';
        }

        function showCheckpointModal(data, checkpointNumber) {
            // Handle both old API (string summary) and new API (object with all data)
            if (typeof data === 'string') {
                // Old API: just summary string
                document.getElementById('checkpointNumber').textContent = checkpointNumber || 1;
                document.getElementById('checkpointNumberMeta').textContent = checkpointNumber || 1;
                document.getElementById('checkpointIterationMeta').textContent = 1;
                document.getElementById('checkpointAgentMeta').textContent = 'Planning';
                document.getElementById('checkpointSummary').innerHTML = data || 'Analysis in progress...';
                // Show empty placeholders for phases
                document.getElementById('memoryContent').innerHTML = '<p style="color: #999;">Loading memory segments...</p>';
                document.getElementById('reasoningContent').innerHTML = '<p style="color: #999;">Loading reasoning chain...</p>';
                document.getElementById('verificationContent').innerHTML = '<p style="color: #999;">Loading verification results...</p>';
                document.getElementById('learningContent').innerHTML = '<p style="color: #999;">Loading learning metrics...</p>';
            } else {
                // New API: object with all checkpoint data
                const checkpoint = data.checkpoint_number || checkpointNumber || 1;
                const iteration = data.iteration || 1;
                const flowMetrics = data.flow_score_metrics || {};
                const agentName = flowMetrics.agent_name || 'Planning';

                // Update header metadata
                document.getElementById('checkpointNumber').textContent = checkpoint;
                document.getElementById('checkpointNumberMeta').textContent = checkpoint;
                document.getElementById('checkpointIteration').textContent = iteration;
                document.getElementById('checkpointIterationMeta').textContent = iteration;
                document.getElementById('checkpointAgentMeta').textContent = agentName;

                document.getElementById('checkpointSummary').innerHTML = data.summary || 'Analysis in progress...';

                // Populate all 4 phases
                populatePhaseData(data);
            }

            // Reset to Memory phase (first tab)
            document.querySelectorAll('.phase-panel').forEach(panel => panel.style.display = 'none');
            document.getElementById('phase-memory').style.display = 'block';
            document.querySelectorAll('.phase-tab').forEach(tab => {
                tab.style.color = '#666';
                tab.style.borderBottomColor = 'transparent';
            });
            document.querySelector('.phase-tab.active').style.color = '#667eea';
            document.querySelector('.phase-tab.active').style.borderBottomColor = '#667eea';

            // Show modal
            document.getElementById('checkpointModal').classList.add('active');
        }

        async function approveCheckpoint() {
            document.getElementById('checkpointModal').classList.remove('active');

            try {
                const response = await fetch('/api/checkpoint-approval', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        checkpoint: currentCheckpointNumber,
                        decision: 'approve'
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to approve checkpoint');
                }

                addMessage('bot', 'Checkpoint approved. Continuing...');
            } catch (e) {
                addMessage('bot', `Error approving checkpoint: ${e.message}`);
            }
        }

        function rejectCheckpoint() {
            document.getElementById('checkpointModal').classList.remove('active');
            addMessage('bot', 'Planning stopped by user');
            if (currentEventSource) {
                currentEventSource.close();
            }
        }

        // ==================== CHAT ====================
        async function sendChat() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            input.value = '';
            addMessage('user', message);

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        session_id: sessionId
                    })
                });

                const data = await response.json();
                addMessage('bot', data.reply || data.response || 'No response');
            } catch (e) {
                addMessage('bot', `Error: ${e.message}`);
            }
        }

        function addMessage(role, content) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${role}`;
            messageEl.innerHTML = `<div class="message-content">${escapeHtml(content)}</div>`;
            messagesDiv.appendChild(messageEl);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // ==================== ITERATION TRACKING ====================
        let iterationState = {
            current: 0,
            max: 0,
            checkpoints: new Set(),
            lastCheckpointIteration: 0
        };

        function initializeIterationTracker(maxIterations) {
            iterationState.current = 0;
            iterationState.max = maxIterations;
            iterationState.checkpoints.clear();
            iterationState.lastCheckpointIteration = 0;

            const tracker = document.getElementById('iterationTracker');
            tracker.style.display = 'block';

            updateIterationDots();
            updateIterationCounter();
        }

        function updateIterationProgress(currentIteration) {
            iterationState.current = currentIteration;
            updateIterationCounter();
            updateIterationDots();
            updateProgressBar();
        }

        function markCheckpointReached(checkpoint, iteration) {
            iterationState.checkpoints.add(checkpoint);
            iterationState.lastCheckpointIteration = iteration;
            updateIterationDots();
        }

        function updateIterationCounter() {
            document.getElementById('iterationCounter').textContent = `${iterationState.current}/${iterationState.max}`;
        }

        function updateProgressBar() {
            const percentage = iterationState.max > 0 ? (iterationState.current / iterationState.max) * 100 : 0;
            const progressFill = document.getElementById('progressBarFill');
            progressFill.style.width = percentage + '%';
            progressFill.textContent = Math.round(percentage) + '%';
        }

        function updateIterationDots() {
            const dotsContainer = document.getElementById('iterationDots');
            dotsContainer.innerHTML = '';

            for (let i = 1; i <= iterationState.max; i++) {
                const dot = document.createElement('div');
                dot.className = 'iteration-dot';
                dot.textContent = i;
                dot.title = `Iteration ${i}`;

                // Mark as active if current iteration
                if (i === iterationState.current) {
                    dot.classList.add('active');
                }

                // Mark as complete if past current iteration
                if (i < iterationState.current) {
                    dot.classList.add('complete');
                }

                // Mark if this iteration had a checkpoint
                // Calculate checkpoint iterations based on interval
                // For now, we'll mark checkpoints that were actually reached
                if (iterationState.checkpoints.size > 0 && i <= iterationState.lastCheckpointIteration) {
                    dot.classList.add('checkpoint');
                }

                dotsContainer.appendChild(dot);
            }

            updateProgressBar();
        }

        function updateProgress(label, value) {
            const progressDiv = document.getElementById('progressItems');
            let item = progressDiv.querySelector(`[data-label="${label}"]`);
            if (!item) {
                item = document.createElement('div');
                item.className = 'progress-item';
                item.setAttribute('data-label', label);
                item.innerHTML = `<div class="progress-label">${label}</div><div class="progress-value"></div>`;
                progressDiv.appendChild(item);
            }
            item.querySelector('.progress-value').textContent = value;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==================== STARTUP ====================
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
